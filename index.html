<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couples Quiz Game</title>
    <!-- 
        This meta tag is a Content Security Policy (CSP). 
        It is required because GitHub Pages has a very strict default CSP that blocks Firebase functions.
        This policy allows scripts from trusted sources (Firebase, Tailwind, Lucide) and enables 
        the necessary connections for the database to function correctly.
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://unpkg.com 'unsafe-inline'; worker-src 'self' blob:; connect-src 'self' https://firestore.googleapis.com https://securetoken.googleapis.com;">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .text-neon-pink { color: #FF69B4; }
        .bg-neon-pink { background-color: #FF69B4; }
        .hover\:bg-neon-pink-darker:hover { background-color: #E65A99; }
        .text-electric-blue { color: #007FFF; }
        .bg-electric-blue { background-color: #007FFF; }
        .hover\:bg-electric-blue-darker:hover { background-color: #0066CC; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-rose-50 dark:from-gray-900 dark:via-purple-950 dark:to-rose-950 flex items-center justify-center p-4 transition-colors duration-500">

    <div id="game-container" class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl w-full max-w-xl p-6 sm:p-8 md:p-10 border border-gray-200 dark:border-gray-700 transition-colors duration-500">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tailwind CSS configuration for custom colors
        const tailwindConfig = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'neon-pink': '#FF69B4',
                        'neon-pink-darker': '#E65A99',
                        'electric-blue': '#007FFF',
                        'electric-blue-darker': '#0066CC',
                    },
                },
            },
        };
        document.head.appendChild(Object.assign(document.createElement('script'), { innerHTML: `tailwind.config = ${JSON.stringify(tailwindConfig)};` }));

        // Get Firebase configuration from the environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- IMPORTANT: Paste your Firebase config here when hosting locally or on GitHub Pages ---
        // You can find this in your Firebase project settings
        const userFirebaseConfig = {
          apiKey: "AIzaSyAkb405RDB01AI8RY6adXO1hWFVKDjkWxY",
          authDomain: "quiz-17b84.firebaseapp.com",
          projectId: "quiz-17b84",
          storageBucket: "quiz-17b84.firebasestorage.app",
          messagingSenderId: "468855544833",
          appId: "1:468855544833:web:1063ec20cbedcce6283400"
        };
        
        // Use the Canvas-provided config if available, otherwise use the user-provided config
        const finalFirebaseConfig = Object.keys(firebaseConfig).length > 0 ? firebaseConfig : userFirebaseConfig;

        // Initialize Firebase
        let app, db, auth;
        try {
            if (!finalFirebaseConfig || !finalFirebaseConfig.projectId) {
                throw new Error("Firebase configuration is missing or incomplete.");
            }
            app = initializeApp(finalFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error('Firebase Initialization Error:', e);
            document.getElementById('game-container').innerHTML = `<div class="text-red-500 dark:text-red-400 text-center p-4">Firebase initialization failed. Please check your configuration.</div>`;
            throw e;
        }

        let user = null;
        let gameId = '';
        let game = null;
        let playerName = '';
        let currentInput = '';
        let loading = false;
        let error = '';
        let feedback = null;
        let unsubscribeFromGame = null;

        const container = document.getElementById('game-container');

        // Theme management
        const toggleTheme = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        };

        // Helper function to render a single view based on the game state
        function render() {
            if (loading) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full min-h-[300px]">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-electric-blue dark:border-neon-pink"></div>
                    </div>
                `;
                return;
            }

            if (error) {
                container.innerHTML = `<div class="text-red-500 dark:text-red-400 text-center p-4">${error}</div>`;
                return;
            }

            if (!user) {
                container.innerHTML = `<div class="text-center p-4 text-gray-600 dark:text-gray-400">Connecting to the game server...</div>`;
                return;
            }
            
            if (!gameId) {
                renderLanding();
            } else if (game && game.status === 'waiting') {
                renderLobby();
            } else if (game && game.status === 'playing') {
                renderPlaying();
            } else if (game && game.status === 'finished') {
                renderGameOver();
            }
            // Initialize Lucide icons on every render
            lucide.createIcons();
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
              themeToggleBtn.addEventListener('click', toggleTheme);
            }
        }

        // --- Render functions for each screen ---
        function renderLanding() {
            container.innerHTML = `
                <div class="text-center p-4 sm:p-8">
                    <div class="flex justify-end mb-4">
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i data-lucide="moon" class="w-6 h-6 dark:hidden"></i>
                            <i data-lucide="sun" class="w-6 h-6 hidden dark:block"></i>
                        </button>
                    </div>
                    <h1 class="text-4xl sm:text-5xl font-extrabold mb-4 text-electric-blue dark:text-neon-pink">Couple's Quiz</h1>
                    <p class="text-lg text-gray-700 dark:text-gray-300 mb-8">A fun way to connect and test how well you know each other!</p>
                    <div class="mb-6">
                        <label for="playerName" class="block text-gray-700 dark:text-gray-300 text-lg mb-2">Your Name:</label>
                        <input id="playerName" type="text" placeholder="Enter your name" class="w-full max-w-sm mx-auto px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-electric-blue dark:focus:ring-neon-pink" required />
                    </div>
                    <div class="mt-8 space-y-4">
                        <button id="create-game" class="w-full max-w-sm mx-auto flex items-center justify-center px-6 py-3 bg-neon-pink text-white rounded-lg shadow-lg hover:bg-neon-pink-darker transition-colors disabled:opacity-50">
                            <i data-lucide="sparkles" class="mr-2"></i> Create New Game
                        </button>
                        <div class="flex items-center">
                            <hr class="flex-grow border-t border-gray-300 dark:border-gray-600" />
                            <span class="mx-4 text-gray-500 dark:text-gray-400">OR</span>
                            <hr class="flex-grow border-t border-gray-300 dark:border-gray-600" />
                        </div>
                        <div class="w-full max-w-sm mx-auto">
                            <label for="joinGameId" class="block text-gray-700 dark:text-gray-300 text-lg mb-2">Join a Game:</label>
                            <input id="joinGameId" type="text" placeholder="Enter Game Code" class="w-full px-4 py-3 border rounded-lg mb-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-neon-pink dark:focus:ring-electric-blue" required />
                            <button id="join-game" class="w-full flex items-center justify-center px-6 py-3 bg-electric-blue text-white rounded-lg shadow-lg hover:bg-electric-blue-darker transition-colors disabled:opacity-50">
                                <i data-lucide="users" class="mr-2"></i> Join Game
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const playerNameInput = document.getElementById('playerName');
            const joinGameIdInput = document.getElementById('joinGameId');
            const createBtn = document.getElementById('create-game');
            const joinBtn = document.getElementById('join-game');

            const updateButtonStates = () => {
                const nameValid = playerNameInput.value.trim() !== '';
                const gameIdValid = joinGameIdInput.value.trim() !== '';
                createBtn.disabled = !nameValid;
                joinBtn.disabled = !(nameValid && gameIdValid);
            };

            // Initial state update
            updateButtonStates();

            playerNameInput.addEventListener('input', (e) => {
                playerName = e.target.value;
                updateButtonStates();
            });
            joinGameIdInput.addEventListener('input', (e) => {
                gameId = e.target.value;
                updateButtonStates();
            });

            createBtn.addEventListener('click', createGame);
            joinBtn.addEventListener('click', joinGame);
        }

        function renderLobby() {
            const isCreator = game.players[0].id === user.uid;
            const gameCodeText = gameId.substring(0, 4) + '-' + gameId.substring(4, 8);
            container.innerHTML = `
                <div class="text-center p-8">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800 dark:text-gray-200">Waiting for a Partner</h2>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-6 mb-6 shadow-inner">
                        <p class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Game Code:</p>
                        <p class="text-4xl font-mono tracking-widest text-electric-blue dark:text-neon-pink">${gameCodeText}</p>
                    </div>
                    <p class="text-lg mb-4 text-gray-600 dark:text-gray-400">Share this code with your partner to have them join the game.</p>
                    <p class="text-lg font-semibold mb-6 text-gray-800 dark:text-gray-200">Current Players:</p>
                    <div class="flex justify-center space-x-4 mb-6">
                        ${game.players.map(p => `<div class="text-xl font-bold text-gray-700 dark:text-gray-300">${p.name}</div>`).join('')}
                    </div>
                    ${isCreator ? `
                        <button id="start-game" class="px-8 py-4 bg-neon-pink text-white font-bold rounded-lg shadow-lg hover:bg-neon-pink-darker transition-colors disabled:opacity-50" ${game.players.length < 2 ? 'disabled' : ''}>
                            Start Game
                        </button>
                    ` : ''}
                </div>
            `;
            if (isCreator) {
                document.getElementById('start-game').addEventListener('click', async () => {
                    const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                    await updateDoc(gameDocRef, { status: 'playing' });
                });
            }
        }

        function renderPlaying() {
            const currentPlayer = game.players.find(p => p.id === user.uid);
            const opponentPlayer = game.players.find(p => p.id !== user.uid);
            const isPlayer1 = game.players[0].id === user.uid;
            const questionIndex = game.currentQuestionIndex;
            const playerAnswered = game.questions[questionIndex].player1Answer && game.questions[questionIndex].player2Answer;

            let mainContent = '';

            if (game.currentTurnPlayerId === user.uid && !game.questions[questionIndex].player1Answer) {
                // This player is providing the question
                mainContent = `
                    <div class="text-center p-8">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">Your Turn, ${currentPlayer.name}!</h3>
                        <p class="text-lg mb-6 text-gray-600 dark:text-gray-400">Ask your partner a question about your relationship. Then enter their answer below:</p>
                        <textarea id="input-field" placeholder="Enter their answer here..." class="w-full h-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-electric-blue dark:focus:ring-neon-pink"></textarea>
                        <button id="submit-btn" class="w-full px-6 py-3 mt-4 bg-neon-pink text-white rounded-lg shadow-lg hover:bg-neon-pink-darker transition-colors disabled:opacity-50">
                            Submit Answer
                        </button>
                    </div>
                `;
            } else if (game.currentTurnPlayerId !== user.uid) {
                // This player is waiting for their partner to ask a question
                mainContent = `
                    <div class="text-center p-8">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">Waiting for ${opponentPlayer.name}...</h3>
                        <p class="text-lg text-gray-600 dark:text-gray-400">Your partner is thinking of a question for you now.</p>
                        <div class="animate-pulse mt-8">
                            <i data-lucide="sparkles" class="w-12 h-12 mx-auto text-neon-pink dark:text-electric-blue"></i>
                        </div>
                    </div>
                `;
            } else if (game.currentTurnPlayerId === user.uid && game.questions[questionIndex].player1Answer && !game.questions[questionIndex].player2Answer) {
                // This player needs to guess the answer
                const opponentAnswer = isPlayer1 ? game.questions[questionIndex].player2Answer : game.questions[questionIndex].player1Answer;
                 mainContent = `
                    <div class="text-center p-8">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">Your Guess, ${currentPlayer.name}!</h3>
                        <p class="text-lg mb-6 text-gray-600 dark:text-gray-400">What do you think their answer was?</p>
                        <textarea id="input-field" placeholder="Enter your guess here..." class="w-full h-32 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-electric-blue dark:focus:ring-neon-pink"></textarea>
                        <button id="submit-btn" class="w-full px-6 py-3 mt-4 bg-electric-blue text-white rounded-lg shadow-lg hover:bg-electric-blue-darker transition-colors disabled:opacity-50">
                            Submit Guess
                        </button>
                        ${feedback === 'correct' ? `
                            <div class="mt-4 text-green-500 font-bold text-xl flex items-center justify-center animate-bounce">
                                <i data-lucide="check" class="mr-2"></i> Correct! +1 Point
                            </div>
                        ` : ''}
                        ${feedback === 'incorrect' ? `
                            <div class="mt-4 text-red-500 font-bold text-xl flex items-center justify-center animate-shake">
                                <i data-lucide="x" class="mr-2"></i> Incorrect.
                            </div>
                        ` : ''}
                    </div>
                `;

            } else {
                 mainContent = `
                    <div class="text-center p-8">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">Waiting for ${opponentPlayer.name}...</h3>
                        <p class="text-lg text-gray-600 dark:text-gray-400">Your partner is guessing your answer now.</p>
                        <div class="animate-pulse mt-8">
                            <i data-lucide="sparkles" class="w-12 h-12 mx-auto text-neon-pink dark:text-electric-blue"></i>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="text-center">
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-t-2xl">
                        <div class="text-lg font-semibold text-electric-blue dark:text-neon-pink">
                            ${game.players[0].name}: ${game.players[0].score}
                        </div>
                        <div class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase">Couples Quiz</div>
                        <div class="text-lg font-semibold text-neon-pink dark:text-electric-blue">
                            ${game.players.length > 1 ? game.players[1].name : 'Waiting...'}: ${game.players.length > 1 ? game.players[1].score : 0}
                        </div>
                    </div>
                    <div class="p-4">
                        ${mainContent}
                    </div>
                </div>
            `;
            const submitBtn = document.getElementById('submit-btn');
            const inputField = document.getElementById('input-field');

            if (submitBtn) {
                submitBtn.disabled = !inputField.value.trim();
                inputField.addEventListener('input', () => {
                    submitBtn.disabled = !inputField.value.trim();
                });
                
                if (game.currentTurnPlayerId === user.uid && !game.questions[questionIndex].player1Answer) {
                    submitBtn.addEventListener('click', handleAnswer);
                } else if (game.currentTurnPlayerId === user.uid && game.questions[questionIndex].player1Answer && !game.questions[questionIndex].player2Answer) {
                    submitBtn.addEventListener('click', handleGuess);
                }
            }
        }

        function renderGameOver() {
            const [player1, player2] = game.players;
            container.innerHTML = `
                <div class="text-center p-8">
                    <h2 class="text-3xl font-bold mb-4 text-gray-800 dark:text-gray-200">Game Over!</h2>
                    <i data-lucide="trophy" class="w-12 h-12 mx-auto text-yellow-500 mb-4"></i>
                    <div class="flex justify-around items-center mb-6">
                        <div class="text-center">
                            <div class="text-xl font-bold text-gray-700 dark:text-gray-300">${player1.name}</div>
                            <div class="text-4xl font-extrabold text-electric-blue dark:text-neon-pink">${player1.score}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-gray-700 dark:text-gray-300">${player2.name}</div>
                            <div class="text-4xl font-extrabold text-neon-pink dark:text-electric-blue">${player2.score}</div>
                        </div>
                    </div>
                    <p class="text-2xl font-semibold mt-4 text-gray-800 dark:text-gray-200">
                        ${player1.score > player2.score ? `${player1.name} wins!` : player2.score > player1.score ? `${player2.name} wins!` : "It's a tie!"}
                    </p>
                    <button id="play-again" class="mt-6 px-6 py-3 bg-neon-pink text-white rounded-lg shadow-lg hover:bg-neon-pink-darker transition-colors">
                        Play Again
                    </button>
                </div>
            `;
            document.getElementById('play-again').addEventListener('click', () => window.location.reload());
        }

        // --- Core game logic functions ---

        async function createGame() {
            if (!playerName.trim()) {
                const errorMessage = 'Please enter your name.';
                setError(errorMessage);
                render();
                return;
            }
            setLoadingState(true);
            try {
                const newGameDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'games'));
                const newGameId = newGameDocRef.id;
                
                const initialGame = {
                    players: [{ id: user.uid, name: playerName, score: 0 }],
                    currentQuestionIndex: 0,
                    status: 'waiting',
                    currentTurnPlayerId: user.uid,
                    questions: [{player1Answer: null, player2Answer: null}],
                    mode: 'couples-quiz',
                };
                await setDoc(newGameDocRef, initialGame);
                gameId = newGameId;
                setLoadingState(false);
            } catch (err) {
                console.error('Error creating game:', err);
                setError('Failed to create game. Please try again. Check console for details.');
                setLoadingState(false);
            }
        }

        async function joinGame() {
            if (!gameId.trim() || !playerName.trim()) {
                const errorMessage = 'Please enter a game code and your name.';
                setError(errorMessage);
                render();
                return;
            }
            setLoadingState(true);
            try {
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const gameDoc = await getDoc(gameDocRef);
                if (gameDoc.exists() && gameDoc.data().players.length < 2) {
                    const gameData = gameDoc.data();
                    const updatedPlayers = [...gameData.players, { id: user.uid, name: playerName, score: 0 }];
                    await updateDoc(gameDocRef, { players: updatedPlayers });
                    setLoadingState(false);
                } else if (!gameDoc.exists()) {
                    const errorMessage = 'Game not found.';
                    setError(errorMessage);
                    setLoadingState(false);
                } else {
                    const errorMessage = 'Game is already full.';
                    setError(errorMessage);
                    setLoadingState(false);
                }
            } catch (err) {
                console.error('Error joining game:', err);
                setError('Failed to join game. Please try again. Check console for details.');
                setLoadingState(false);
            }
        }
        
        async function advanceGame(gameData) {
            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            const nextQuestionIndex = gameData.currentQuestionIndex + 1;
            const nextTurnPlayerId = gameData.players[0].id;
            
            const newQuestions = [...gameData.questions, {player1Answer: null, player2Answer: null}];

            if (nextQuestionIndex < gameData.questions.length + 1) {
                await updateDoc(gameDocRef, {
                    currentQuestionIndex: nextQuestionIndex,
                    currentTurnPlayerId: nextTurnPlayerId,
                    questions: newQuestions,
                });
            } else {
                await updateDoc(gameDocRef, { status: 'finished' });
            }
        }

        async function handleAnswer() {
            if (!game || !currentInput.trim()) return;
            setLoadingState(true);
            try {
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const gameData = { ...game };
                const player1Id = gameData.players[0].id;
                const questionIndex = gameData.currentQuestionIndex;

                if (user.uid === player1Id) {
                    gameData.questions[questionIndex].player1Answer = currentInput;
                    gameData.currentTurnPlayerId = gameData.players[1].id;
                } else {
                    gameData.questions[questionIndex].player2Answer = currentInput;
                    gameData.currentTurnPlayerId = player1Id;
                }
                
                await updateDoc(gameDocRef, { questions: gameData.questions, currentTurnPlayerId: gameData.currentTurnPlayerId });
                currentInput = '';
                setLoadingState(false);
            } catch (err) {
                console.error('Error submitting answer:', err);
                setError('Failed to submit answer.');
                setLoadingState(false);
            }
        }

        async function handleGuess() {
            if (!game || !currentInput.trim()) return;
            setLoadingState(true);
            try {
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const gameData = { ...game };
                const currentPlayerIndex = gameData.players.findIndex(p => p.id === user.uid);
                const questionIndex = gameData.currentQuestionIndex;

                const opponentAnswer = (user.uid === gameData.players[0].id) ? gameData.questions[questionIndex].player2Answer : gameData.questions[questionIndex].player1Answer;
                const isCorrect = currentInput.trim().toLowerCase() === opponentAnswer.trim().toLowerCase();
                
                if (isCorrect) {
                    gameData.players[currentPlayerIndex].score += 1;
                    feedback = 'correct';
                } else {
                    feedback = 'incorrect';
                }

                await updateDoc(gameDocRef, { players: gameData.players });
                currentInput = '';
                renderPlaying();
                setTimeout(() => {
                    advanceGame(gameData);
                }, 2000);
            } catch (err) {
                console.error('Error submitting guess:', err);
                setError('Failed to submit guess.');
                setLoadingState(false);
            }
        }
        
        // --- State management functions ---
        function setLoadingState(isLoading) {
            loading = isLoading;
            render();
        }

        // --- Event listeners and initial setup ---
        async function init() {
            loadTheme();
            // We'll try to sign in with a custom token. If that fails, we'll sign in anonymously.
            // This is crucial for a real-time multiplayer game.
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error('Authentication failed, falling back to anonymous sign-in:', error);
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (currentUser) => {
                user = currentUser;
                render();
            });
        }
        
        window.addEventListener('load', () => {
            init();
            
            // Listen for changes to gameId
            Object.defineProperty(window, 'gameId', {
                get: () => gameId,
                set: (value) => {
                    gameId = value;
                    if (unsubscribeFromGame) unsubscribeFromGame();
                    if (gameId) {
                        const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                        unsubscribeFromGame = onSnapshot(gameDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const gameData = docSnap.data();
                                const oldQuestionIndex = game ? game.currentQuestionIndex : -1;
                                game = gameData;
                                if (game.currentQuestionIndex !== oldQuestionIndex) {
                                  feedback = null;
                                }
                                render();
                            } else {
                                game = null;
                                gameId = '';
                                setError('Game not found.');
                                render();
                            }
                        }, (err) => {
                            console.error('Firestore onSnapshot error:', err);
                            setError('Failed to fetch game data.');
                            render();
                        });
                    }
                }
            });
        });
    </script>
</body>
</html>
